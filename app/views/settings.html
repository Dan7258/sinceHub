<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки</title>
    <!-- Подключаем Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 0;
            color: #333;
        }

        * {
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px;
            margin: 80px auto;
            padding: 20px;
        }
        h1 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .settings-section {
            margin-bottom: 30px;
        }
        .settings-section h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .settings-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            word-wrap: break-word;
        }
        .settings-section input[type="text"],
        .settings-section input[type="password"],
        .settings-section select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        /* Добавим стиль для контейнера с паролем и иконкой */
        .password-container {
            position: relative;
        }
        .password-container input {
            padding-right: 40px; /* Оставим место для иконки */
        }
        .password-container .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 1.2em;
        }
        .settings-section .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .settings-section .row > div {
            flex: 1;
            min-width: 200px;
        }
        .settings-section button {
            padding: 10px 20px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .settings-section button:hover {
            background-color: #218838;
        }

        @media (max-width: 768px) {
            .settings-section .row {
                flex-direction: column;
            }
            .settings-section .row > div {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
{{template "header.html"}} <!-- Подключение header -->
<div class="container">
    <h1>Настройки</h1>
    <div class="settings-section">
        <h2>О себе</h2>
        <div class="row">
            <div>
                <label for="last_name">Фамилия</label>
                <input type="text" id="last_name" placeholder="Фамилия">
            </div>
            <div>
                <label for="first_name">Имя</label>
                <input type="text" id="first_name" placeholder="Имя">
            </div>
            <div>
                <label for="middle_name">Отчество</label>
                <input type="text" id="middle_name" placeholder="Отчество">
            </div>
        </div>
        <div class="row">
            <div>
                <label for="country">Страна</label>
                <input type="text" id="country" placeholder="Страна">
            </div>
            <div>
                <label for="academic_degree">Учёная степень</label>
                <input type="text" id="academic_degree" placeholder="Учёная степень">
            </div>
        </div>
        <div class="row">
            <div>
                <label for="vac">ВАК</label>
                <input type="text" id="vac" placeholder="ВАК">
            </div>
            <div>
                <label for="appointment">Должность</label>
                <input type="text" id="appointment" placeholder="Должность">
            </div>
        </div>
        <button id="saveProfileButton">Сохранить</button>
    </div>
    <div class="settings-section">
        <h2>Смена логина</h2>
        <label for="new_login">Новый логин</label>
        <input type="text" id="new_login" placeholder="Текущий логин">
        <button id="changeLoginButton">Изменить логин</button>
        <!-- Поле для ввода кода и кнопки "Подтвердить" и "Остановить изменение" -->
        <div id="codeSection" style="display: none;">
            <label for="verification_code">Код подтверждения</label>
            <input type="text" id="verification_code" placeholder="Введите код с почты">
            <div class="button-group">
                <button id="verifyCodeButton">Подтвердить</button>
                <button id="stopChangeButton">Остановить изменение</button>
            </div>
        </div>
    </div>
    <div class="settings-section">
        <h2>Безопасность</h2>
        <label for="current_password">Текущий пароль</label>
        <div class="password-container">
            <input type="password" id="current_password" placeholder="Введите текущий пароль">
            <i class="fas fa-eye toggle-password" id="toggleCurrentPassword"></i>
        </div>
        <label for="new_password">Новый пароль</label>
        <input type="password" id="new_password" placeholder="Введите новый пароль">
        <label for="confirm_password">Подтвердите пароль</label>
        <input type="password" id="confirm_password" placeholder="Подтвердите новый пароль">
        <button id="changePasswordButton">Изменить пароль</button>
        <div id="passwordCodeSection" style="display: none;">
            <label for="password_verification_code">Код подтверждения</label>
            <input type="text" id="password_verification_code" placeholder="Введите код">
            <button id="verifyPasswordCodeButton">Подтвердить</button>
            <button id="stopChangePasswordButton">Остановить изменение</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Переменная для хранения текущего логина пользователя
        let currentUserLogin = '';

        // Запрос данных пользователя
        fetch('/getUserData', { credentials: 'include' })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return Promise.reject('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('last_name').placeholder = data.last_name || 'Фамилия';
                document.getElementById('first_name').placeholder = data.first_name || 'Имя';
                document.getElementById('middle_name').placeholder = data.middle_name || 'Отчество';
                document.getElementById('country').placeholder = data.country || 'Страна';
                document.getElementById('academic_degree').placeholder = data.academic_degree || 'Учёная степень';
                document.getElementById('vac').placeholder = data.vac || 'ВАК';
                document.getElementById('appointment').placeholder = data.appointment || 'Должность';
                document.getElementById('new_login').placeholder = data.login || 'Текущий логин';
                currentUserLogin = data.login || '';
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных пользователя:', error);
            });

        // Логика для переключения видимости текущего пароля
        const togglePassword = document.getElementById('toggleCurrentPassword');
        const passwordInput = document.getElementById('current_password');
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Обработчик для смены логина
        const changeLoginButton = document.getElementById('changeLoginButton');
        const codeSection = document.getElementById('codeSection');
        const verifyCodeButton = document.getElementById('verifyCodeButton');
        const stopChangeButton = document.getElementById('stopChangeButton');

        changeLoginButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            if (!newLogin) {
                alert('Введите новый логин');
                return;
            }
            fetch('/send-verification-code-for-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: newLogin }),
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert('Код подтверждения отправлен на вашу почту');
                        codeSection.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при отправке кода подтверждения');
                });
        });

        verifyCodeButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            const verificationCode = document.getElementById('verification_code').value.trim();
            if (!newLogin || !verificationCode) {
                alert('Заполните все поля');
                return;
            }
            fetch('/settings/verify-and-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { login: newLogin }, code: verificationCode }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Логин успешно изменен');
                        window.location.reload();
                    } else {
                        alert('Ошибка при изменении логина');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при изменении логина');
                });
        });

        stopChangeButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            if (!newLogin) {
                alert('Нет данных для остановки изменения');
                return;
            }
            fetch('/settings/stop-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { login: newLogin }, code: '' }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Изменение логина остановлено');
                        window.location.reload();
                    } else {
                        alert('Ошибка при остановке изменения логина');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при остановке изменения логина');
                });
        });

        // Обработчик для сохранения профиля
        document.getElementById('saveProfileButton').addEventListener('click', function() {
            const nonEmptyFields = getNonEmptyFields();
            if (Object.keys(nonEmptyFields).length === 0) {
                alert('Нет данных для сохранения');
                return;
            }
            fetch('/profiles/', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nonEmptyFields),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Данные успешно обновлены');
                        window.location.reload();
                    } else {
                        alert('Ошибка при обновлении данных');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при обновлении данных');
                });
        });

        function getNonEmptyFields() {
            const fields = ['last_name', 'first_name', 'middle_name', 'country', 'academic_degree', 'vac', 'appointment'];
            const data = {};
            fields.forEach(field => {
                const value = document.getElementById(field).value.trim();
                if (value) {
                    data[field] = value;
                }
            });
            return data;
        }

        // Обработчик для смены пароля
        const changePasswordButton = document.getElementById('changePasswordButton');
        const passwordCodeSection = document.getElementById('passwordCodeSection');
        const verifyPasswordCodeButton = document.getElementById('verifyPasswordCodeButton');
        const stopChangePasswordButton = document.getElementById('stopChangePasswordButton');

        changePasswordButton.addEventListener('click', function() {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Заполните все поля');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('Новый пароль и подтверждение не совпадают');
                return;
            }
            if (newPassword === currentPassword) {
                alert('Новый пароль не должен совпадать с текущим паролем');
                return;
            }
            if (!currentUserLogin) {
                alert('Не удалось определить текущий логин. Попробуйте перезагрузить страницу.');
                return;
            }

            fetch('/send-verification-code-for-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: currentUserLogin }),
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert('Код подтверждения отправлен на вашу почту');
                        passwordCodeSection.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке кода:', error);
                    alert('Ошибка при отправке кода подтверждения');
                });
        });

        verifyPasswordCodeButton.addEventListener('click', function() {
            const newPassword = document.getElementById('new_password').value;
            const verificationCode = document.getElementById('password_verification_code').value.trim();

            if (!newPassword || !verificationCode) {
                alert('Заполните все поля');
                return;
            }

            fetch('/settings/verify-and-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { password: newPassword }, code: verificationCode }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Пароль успешно изменен');
                        window.location.reload();
                    } else {
                        alert('Ошибка при изменении пароля');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при изменении пароля');
                });
        });

        stopChangePasswordButton.addEventListener('click', function() {
            fetch('/settings/stop-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: {}, code: '' }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Изменение пароля остановлено');
                        window.location.reload();
                    } else {
                        alert('Ошибка при остановке изменения пароля');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при остановке изменения пароля');
                });
        });
    });
</script>
</body>
</html>