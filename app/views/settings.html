<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки</title>
    <!-- Подключаем Font Awesome для иконок -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 960px;
            margin: 60px auto;
            padding: 20px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 30px;
            text-align: center;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1em;
        }

        button {
            all: unset;
            width: 142px;
            height: 41px;
            background-color: #4D38D7 !important;
            color: white !important;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background-color: #3b2bb3 !important;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #565e64;
        }


        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .button-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .code-block {
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        /* Media */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

    </style>
</head>
<body>
{{template "header.html"}}
<main class="container">

    <!-- Секция "О себе" -->
    <section class="card">
        <h2>О себе</h2>
        <div class="grid-3">
            <div>
                <label for="last_name">Фамилия</label>
                <input type="text" id="last_name" placeholder="Фамилия" />
            </div>
            <div>
                <label for="first_name">Имя</label>
                <input type="text" id="first_name" placeholder="Имя" />
            </div>
            <div>
                <label for="middle_name">Отчество</label>
                <input type="text" id="middle_name" placeholder="Отчество" />
            </div>
            <div>
                <label for="country">Страна</label>
                <input type="text" id="country" placeholder="Страна" />
            </div>
            <div>
                <label for="academic_degree">Учёная степень</label>
                <input type="text" id="academic_degree" placeholder="Учёная степень" />
            </div>
            <div>
                <label for="vac">ВАК</label>
                <input type="text" id="vac" placeholder="ВАК" />
            </div>
            <div>
                <label for="appointment">Должность</label>
                <input type="text" id="appointment" placeholder="Должность" />
            </div>
        </div>
        <button id="saveProfileButton">Сохранить</button>
    </section>

    <!-- Секция "Смена логина" -->
    <section class="card">
        <h2>Смена логина</h2>
        <label for="new_login">Новый логин</label>
        <input type="text" id="new_login" placeholder="Текущий логин" />
        <button id="changeLoginButton">Изменить логин</button>

        <div id="codeSection" class="code-block hidden">
            <label for="verification_code">Код подтверждения</label>
            <input type="text" id="verification_code" placeholder="Введите код с почты" />
            <div class="button-row">
                <button id="verifyCodeButton">Подтвердить</button>
                <button id="stopChangeButton" class="secondary">Остановить</button>
            </div>
        </div>
    </section>

    <!-- Секция "Безопасность" -->
    <section class="card">
        <h2>Безопасность</h2>
        <label for="current_password">Текущий пароль</label>
        <div class="password-container">
            <input type="password" id="current_password" placeholder="Введите текущий пароль" />
            <i class="fas fa-eye toggle-password" id="toggleCurrentPassword"></i>
        </div>

        <label for="new_password">Новый пароль</label>
        <input type="password" id="new_password" placeholder="Введите новый пароль" />

        <label for="confirm_password">Подтвердите пароль</label>
        <input type="password" id="confirm_password" placeholder="Подтвердите новый пароль" />

        <button id="changePasswordButton">Изменить пароль</button>

        <div id="passwordCodeSection" class="code-block hidden">
            <label for="password_verification_code">Код подтверждения</label>
            <input type="text" id="password_verification_code" placeholder="Введите код" />
            <div class="button-row">
                <button id="verifyPasswordCodeButton">Подтвердить</button>
                <button id="stopChangePasswordButton" class="secondary">Остановить</button>
            </div>
        </div>
    </section>
</main>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Переменная для хранения текущего логина пользователя
        let currentUserLogin = '';

        // Запрос данных пользователя
        fetch('/getUserData', { credentials: 'include' })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return Promise.reject('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('last_name').placeholder = data.last_name || 'Фамилия';
                document.getElementById('first_name').placeholder = data.first_name || 'Имя';
                document.getElementById('middle_name').placeholder = data.middle_name || 'Отчество';
                document.getElementById('country').placeholder = data.country || 'Страна';
                document.getElementById('academic_degree').placeholder = data.academic_degree || 'Учёная степень';
                document.getElementById('vac').placeholder = data.vac || 'ВАК';
                document.getElementById('appointment').placeholder = data.appointment || 'Должность';
                document.getElementById('new_login').placeholder = data.login || 'Текущий логин';
                currentUserLogin = data.login || '';
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных пользователя:', error);
            });

        // Логика для переключения видимости текущего пароля
        const togglePassword = document.getElementById('toggleCurrentPassword');
        const passwordInput = document.getElementById('current_password');
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Обработчик для смены логина
        const changeLoginButton = document.getElementById('changeLoginButton');
        const codeSection = document.getElementById('codeSection');
        const verifyCodeButton = document.getElementById('verifyCodeButton');
        const stopChangeButton = document.getElementById('stopChangeButton');

        changeLoginButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            if (!newLogin) {
                alert('Введите новый логин');
                return;
            }
            fetch('/send-verification-code-for-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: newLogin }),
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert('Код подтверждения отправлен на вашу почту');
                        codeSection.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при отправке кода подтверждения');
                });
        });

        verifyCodeButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            const verificationCode = document.getElementById('verification_code').value.trim();
            if (!newLogin || !verificationCode) {
                alert('Заполните все поля');
                return;
            }
            fetch('/settings/verify-and-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { login: newLogin }, code: verificationCode }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Логин успешно изменен');
                        window.location.reload();
                    } else {
                        alert('Ошибка при изменении логина');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при изменении логина');
                });
        });

        stopChangeButton.addEventListener('click', function() {
            const newLogin = document.getElementById('new_login').value.trim();
            if (!newLogin) {
                alert('Нет данных для остановки изменения');
                return;
            }
            fetch('/settings/stop-change-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { login: newLogin }, code: '' }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Изменение логина остановлено');
                        window.location.reload();
                    } else {
                        alert('Ошибка при остановке изменения логина');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при остановке изменения логина');
                });
        });

        // Обработчик для сохранения профиля
        document.getElementById('saveProfileButton').addEventListener('click', function() {
            const nonEmptyFields = getNonEmptyFields();
            if (Object.keys(nonEmptyFields).length === 0) {
                alert('Нет данных для сохранения');
                return;
            }
            fetch('/profiles/', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nonEmptyFields),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Данные успешно обновлены');
                        window.location.reload();
                    } else {
                        alert('Ошибка при обновлении данных');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при обновлении данных');
                });
        });

        function getNonEmptyFields() {
            const fields = ['last_name', 'first_name', 'middle_name', 'country', 'academic_degree', 'vac', 'appointment'];
            const data = {};
            fields.forEach(field => {
                const value = document.getElementById(field).value.trim();
                if (value) {
                    data[field] = value;
                }
            });
            return data;
        }

        // Обработчик для смены пароля
        const changePasswordButton = document.getElementById('changePasswordButton');
        const passwordCodeSection = document.getElementById('passwordCodeSection');
        const verifyPasswordCodeButton = document.getElementById('verifyPasswordCodeButton');
        const stopChangePasswordButton = document.getElementById('stopChangePasswordButton');

        changePasswordButton.addEventListener('click', function() {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Заполните все поля');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('Новый пароль и подтверждение не совпадают');
                return;
            }
            if (newPassword === currentPassword) {
                alert('Новый пароль не должен совпадать с текущим паролем');
                return;
            }
            if (!currentUserLogin) {
                alert('Не удалось определить текущий логин. Попробуйте перезагрузить страницу.');
                return;
            }

            fetch('/send-verification-code-for-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: currentUserLogin }),
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert('Код подтверждения отправлен на вашу почту');
                        passwordCodeSection.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке кода:', error);
                    alert('Ошибка при отправке кода подтверждения');
                });
        });

        verifyPasswordCodeButton.addEventListener('click', function() {
            const newPassword = document.getElementById('new_password').value;
            const verificationCode = document.getElementById('password_verification_code').value.trim();

            if (!newPassword || !verificationCode) {
                alert('Заполните все поля');
                return;
            }

            fetch('/settings/verify-and-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: { password: newPassword }, code: verificationCode }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Пароль успешно изменен');
                        window.location.reload();
                    } else {
                        alert('Ошибка при изменении пароля');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при изменении пароля');
                });
        });

        stopChangePasswordButton.addEventListener('click', function() {
            fetch('/settings/stop-change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: {}, code: '' }),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Изменение пароля остановлено');
                        window.location.reload();
                    } else {
                        alert('Ошибка при остановке изменения пароля');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при остановке изменения пароля');
                });
        });
    });
</script>
</body>
</html>