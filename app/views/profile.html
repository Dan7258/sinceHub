<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 95%;
            margin: 50px auto;
            padding: 20px;
            padding-top: 80px;
            display: flex;
            gap: 20px;
            flex-direction: column;
        }
        .profile-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .profile-info img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ccc;
        }
        .profile-details {
            display: flex;
            flex-direction: column;
        }
        .profile-details h2 {
            margin: 5px 0;
        }
        .profile-details p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .user-id {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        .main-content {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .main-content h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .publication-list, .subscriptions-list {
            margin-bottom: 20px;
        }
        .publication-item, .subscription-item {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background: #28a745;
            color: #fff;
            border-radius: 3px;
            text-decoration: none;
        }
        .publication-item:hover, .subscription-item:hover {
            background: #218838;
        }
        .subscription-item.unsubscribed {
            background: #007bff;
        }
        .subscription-item.unsubscribed:hover {
            background: #0056b3;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #fff;
            font-size: 1em;
        }
        .action-buttons .subscribers-btn {
            background: #3498db;
        }
        .action-buttons .subscribers-btn:hover {
            background: #2980b9;
        }
        .action-buttons .subscriptions-btn {
            background: #9b59b6;
        }
        .action-buttons .subscriptions-btn:hover {
            background: #8e44ad;
        }
        .action-buttons .create-publication-btn {
            background: #28a745;
        }
        .action-buttons .create-publication-btn:hover {
            background: #218838;
        }
        .publication {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .publication h3 {
            margin: 0 0 10px;
        }
        .publication p {
            margin: 5px 0;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .profile-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/getUserData', { credentials: 'include' })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        document.querySelector('header').style.display = 'none';
                        return Promise.reject('Unauthorized');
                    }
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelector('header').style.display = 'block';
                    document.getElementById('user_id').innerText = data.id;
                    document.getElementById('first_name').innerText = data.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('last_name').innerText = data.last_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('middle_name').innerText = data.middle_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('country').innerText = data.country || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                    document.getElementById('academic_degree').innerText = data.academic_degree || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                    document.getElementById('appointment').innerText = data.appointment || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('subscribers_count').innerText = data.SubscribersList?.length || 0;
                    document.getElementById('subscriptions_count').innerText = data.MySubscribesList?.length || 0;
                    const publicationsList = document.getElementById('publications');
                    publicationsList.innerHTML = '';
                    if (data.Publications && data.Publications.length > 0) {
                        data.Publications.forEach(pub => {
                            const div = document.createElement('div');
                            div.className = 'publication';
                            const isOwner = data.id === pub.owner_id;

                            div.innerHTML = `
                            <h3>${pub.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                            <p><strong>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:</strong> ${pub.abstract || '–ù–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏'}</p>
                            <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> ${new Date(pub.created_at).toLocaleDateString()}</p>
                            <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${new Date(pub.updated_at).toLocaleDateString()}</p>

                            <div style="margin: 10px 0;">
                                <strong>–°–æ–∞–≤—Ç–æ—Ä—ã:</strong> ${
                                                    pub.profiles && pub.profiles.length > 0
                                                        ? pub.profiles.map(p => `${p.first_name || ''} ${p.last_name || ''}`.trim()).join(', ')
                                                        : '–°–æ–∞–≤—Ç–æ—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã'
                                                }
                            </div>

                            <div style="margin: 10px 0;">
                                <strong>–¢–µ–≥–∏:</strong> ${
                                                    pub.tags && pub.tags.length > 0
                                                        ? pub.tags.map(tag => `<span style="background:#3498db; color:white; padding:3px 8px; border-radius:12px; margin-right:5px;">${tag.name}</span>`).join(' ')
                                                        : '–¢–µ–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã'
                                                }
                            </div>

                            <div style="margin-top: 10px;">
                                ${pub.file_link ? `<a href="${pub.file_link}" target="_blank" style="margin-right: 15px; color:#2980b9; text-decoration: none;">üìÑ –°–∫–∞—á–∞—Ç—å —Å—Ç–∞—Ç—å—é (PDF)</a>` : ''}
                                ${
                                                            isOwner
                                                                ? `<a href="/edit-publication?id=${pub.id}" style="color: #e67e22; text-decoration: none; margin-right: 15px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>`
                                                                : `<button onclick="notMyPublication(${pub.id})" style="padding: 5px 10px; border: none; background: #e74c3c; color: #fff; border-radius: 5px; cursor: pointer;">‚ùå –Ø –Ω–µ —è–≤–ª—è—é—Å—å —Å–æ–∞–≤—Ç–æ—Ä–æ–º</button>`
                                                        }
                            </div>
                        `;
                            publicationsList.appendChild(div);
                        });
                    } else {
                        publicationsList.innerHTML = '–ü—É–±–ª–∏–∫–∞—Ü–∏–π –Ω–µ—Ç';
                    }
                    const subscribersList = document.getElementById('subscribers_list');
                    subscribersList.innerHTML = '';
                    if (data.SubscribersList && data.SubscribersList.length > 0) {
                        data.SubscribersList.forEach(sub => {
                            const a = document.createElement('a');
                            a.className = 'subscription-item';
                            a.href = '#';
                            a.innerText = `${sub.first_name} ${sub.last_name}`.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                            subscribersList.appendChild(a);
                        });
                    } else {
                        subscribersList.innerHTML = '–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–µ—Ç';
                    }
                    const mySubscribesList = document.getElementById('my_subscribes_list');
                    mySubscribesList.innerHTML = '';
                    if (data.MySubscribesList && data.MySubscribesList.length > 0) {
                        data.MySubscribesList.forEach(sub => {
                            const a = document.createElement('a');
                            a.className = 'subscription-item unsubscribed';
                            a.href = '#';
                            a.innerText = `${sub.first_name} ${sub.last_name}`.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                            mySubscribesList.appendChild(a);
                        });
                    } else {
                        mySubscribesList.innerHTML = '–ü–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                    document.querySelector('.container').innerHTML =
                        '<p style="color: #e74c3c;">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è</p>';
                });

            document.getElementById('subscribers_btn').addEventListener('click', function() {
                document.getElementById('subscribers_list').scrollIntoView({ behavior: 'smooth' });
            });
            document.getElementById('subscriptions_btn').addEventListener('click', function() {
                document.getElementById('my_subscribes_list').scrollIntoView({ behavior: 'smooth' });
            });
            document.getElementById('create_publication_btn').addEventListener('click', function() {
                window.location.href = '/create-publication';
            });
        });

        function deletePublication(id) {
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é?")) return;
            fetch(`/delete-publication?id=${id}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(res => {
                    if (res.ok) {
                        alert("–ü—É–±–ª–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞");
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏");
                    }
                });
        }

        function notMyPublication(publicationId) {
            const confirmed = confirm("–í—ã —Ç–æ—á–Ω–æ –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∞–≤—Ç–æ—Ä–æ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏?");
            if (!confirmed) return;

            const authorId = parseInt(document.getElementById('user_id').innerText);

            fetch('/publications/delete-author', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    id_publication: publicationId,
                    id_author: authorId
                })
            })
                .then(res => {
                    if (res.status >= 200 && res.status < 400) {
                        alert("–í—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ–∞–≤—Ç–æ—Ä–æ–≤.");
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —Å–æ–∞–≤—Ç–æ—Ä–æ–≤.");
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏.");
                });
        }

    </script>
</head>
<body>
{{template "header.html"}}
<div class="container">
    <div class="profile-info">
<!--        <div class="user-id" id="user_id"></div>-->
        <img src="https://via.placeholder.com/100" alt="–ê–≤–∞—Ç–∞—Ä">
        <div class="profile-details">
            <h2 id="first_name"></h2>
            <h2 id="last_name"></h2>
            <h2 id="middle_name"></h2>
            <p>ID –≤ —Å–∏—Å—Ç–µ–º–µ: <span id="user_id"></span></p>
            <p>–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å: <span id="academic_degree"></span></p>
            <p>–î–æ–ª–∂–Ω–æ—Å—Ç—å: <span id="appointment"></span></p>
            <p>–°—Ç—Ä–∞–Ω–∞: <span id="country"></span></p>
            <p>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: <span id="subscribers_count"></span></p>
            <p>–ü–æ–¥–ø–∏—Å–∫–∏: <span id="subscriptions_count"></span></p>
        </div>
    </div>
    <div class="action-buttons">
        <button id="subscribers_btn" class="subscribers-btn">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</button>
        <button id="subscriptions_btn" class="subscriptions-btn">–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</button>
        <button id="create_publication_btn" class="create-publication-btn">–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</button>
    </div>
    <div class="main-content">
        <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h2>
        <div class="publication-list" id="publications">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        <h2>–°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</h2>
        <div class="subscriptions-list" id="subscribers_list">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        <h2>–°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫</h2>
        <div class="subscriptions-list" id="my_subscribes_list">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
    </div>
</div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'923dc6de589e12ee',t:'MTc0MjU2MzU0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>